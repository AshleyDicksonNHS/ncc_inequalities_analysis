---
title: "Neonatal Critical Care Base Dataset: Construction and Descriptive Statistics"
author: "Ashley Dickson"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    number-sections: true
    theme: flatly
    code-fold: true
    self-contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 5)

# Load bit64 BEFORE reading data (required for integer64 columns)
library(bit64)
library(tidyverse)
library(knitr)
library(kableExtra)
library(scales)

# Load the dataset
data <- readRDS("data/ncc_base_dataset.rds")

# Convert gestation from days to weeks (stored as integer64 days)
data <- data %>%
  mutate(Gestation_Weeks = as.numeric(Gestation_Length_At_Birth) / 7)

# Ethnicity code lookup (NHS Data Dictionary)
ethnicity_lookup <- c(
  "A" = "White - British",
  "B" = "White - Irish",
  "C" = "White - Other",
  "D" = "Mixed - White & Black Caribbean",
  "E" = "Mixed - White & Black African",
  "F" = "Mixed - White & Asian",
  "G" = "Mixed - Other",
  "H" = "Asian - Indian",
  "J" = "Asian - Pakistani",
  "K" = "Asian - Bangladeshi",
  "L" = "Asian - Other",
  "M" = "Black - Caribbean",
  "N" = "Black - African",
  "P" = "Black - Other",
  "R" = "Chinese",
  "S" = "Other Ethnic Group",
  "Z" = "Not Stated",
  "99" = "Not Known"
)

# Delivery method lookup (SNOMED CT codes simplified)
delivery_lookup <- c(
  "0" = "Spontaneous Vertex",
  "1" = "Spontaneous Other Cephalic",
  "2" = "Low Forceps",
  "3" = "Other Forceps",
  "4" = "Ventouse/Vacuum",
  "5" = "Breech",
  "6" = "Breech Extraction",
  "7" = "Elective Caesarean",
  "8" = "Emergency Caesarean",
  "9" = "Other"
)

# Helper function to decode
decode_ethnicity <- function(code) {
  ifelse(is.na(code), "Missing",
         ifelse(code %in% names(ethnicity_lookup), ethnicity_lookup[code], paste0("Other (", code, ")")))
}

decode_delivery <- function(code) {
  ifelse(is.na(code), "Missing",
         ifelse(code %in% names(delivery_lookup), delivery_lookup[code], paste0("Other (", code, ")")))
}

# NHS colour palette
nhs_blue <- "#005EB8"
nhs_dark_blue <- "#003087"
nhs_bright_blue <- "#0072CE"
nhs_light_blue <- "#41B6E6"
nhs_aqua <- "#00A9CE"
nhs_pink <- "#AE2573"
nhs_green <- "#009639"
```

# Executive Summary

This report documents the construction of the base dataset for analysing inequalities in Neonatal Critical Care (NCC) access in England. The dataset links maternity services data (MSDS) with critical care data to create a comprehensive birth-level dataset for hierarchical modelling.

**Key findings:**

- **Final dataset**: `r format(nrow(data), big.mark = ",")` births in financial year 2023/24
- **NCC admission rate**: `r round(100 * mean(data$NCC_Admitted, na.rm = TRUE), 1)`% (`r format(sum(data$NCC_Admitted, na.rm = TRUE), big.mark = ",")` babies)
- **Critical data quality issue identified and resolved**: MSDS tables contained 2-10x duplication due to multiple submissions
- **Data source selection**: Critical Care (CC) data preferred over MSDS for NCC admissions due to contractual reporting requirements and better data quality

## What This Means {.unnumbered}

This analysis looks at which babies receive specialist neonatal critical care in England. We found that approximately **1 in 8 babies** (12.5%) born in hospital require some form of neonatal critical care.

The data we've assembled will help us understand whether all babies have **equal access** to this care, regardless of their:

- Ethnic background
- Family's socioeconomic circumstances
- Where they live in England
- Their mother's social circumstances

Understanding these patterns is the first step toward ensuring every baby gets the care they need, when they need it.

---

# Key Findings at a Glance

```{r key_viz, echo=FALSE, fig.height=4}
#| label: fig-overview
#| fig-cap: "Overview of NCC admissions in the dataset"

# Create summary data for visualization
ncc_summary <- data %>%
  summarise(
    `Admitted to NCC` = sum(NCC_Admitted, na.rm = TRUE),
    `Not admitted` = sum(NCC_Admitted == 0, na.rm = TRUE)
  ) %>%
  pivot_longer(everything(), names_to = "Status", values_to = "Count") %>%
  mutate(
    Percentage = Count / sum(Count) * 100,
    Label = paste0(format(Count, big.mark = ","), "\n(", round(Percentage, 1), "%)")
  )

ggplot(ncc_summary, aes(x = Status, y = Count, fill = Status)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = Label), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("Admitted to NCC" = nhs_blue, "Not admitted" = nhs_light_blue)) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Neonatal Critical Care Admissions",
    subtitle = "Financial Year 2023/24",
    x = NULL,
    y = "Number of Babies"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 14),
    panel.grid.major.x = element_blank()
  )
```

```{r ncc_by_ethnicity_viz, echo=FALSE, fig.height=5}
#| label: fig-ethnicity-rates
#| fig-cap: "NCC admission rates vary by ethnic group"

# Calculate NCC rates by ethnicity
ethnicity_rates <- data %>%
  mutate(Ethnicity = decode_ethnicity(Ethnic_Category_Baby)) %>%
  group_by(Ethnicity) %>%
  summarise(
    Total = n(),
    NCC_Admitted = sum(NCC_Admitted, na.rm = TRUE),
    Rate = 100 * NCC_Admitted / Total,
    .groups = "drop"
  ) %>%
  filter(Total >= 1000) %>%  # Only show groups with sufficient numbers

  arrange(desc(Rate))

ggplot(ethnicity_rates, aes(x = reorder(Ethnicity, Rate), y = Rate, fill = Rate)) +
  geom_col() +
  geom_hline(yintercept = mean(data$NCC_Admitted, na.rm = TRUE) * 100,
             linetype = "dashed", color = "red", linewidth = 0.8) +
  annotate("text", x = 1, y = mean(data$NCC_Admitted, na.rm = TRUE) * 100 + 0.5,
           label = "Overall average", hjust = 0, color = "red", size = 3) +
  coord_flip() +
  scale_fill_gradient(low = nhs_light_blue, high = nhs_dark_blue, guide = "none") +
  labs(
    title = "NCC Admission Rate by Baby's Ethnicity",
    subtitle = "Groups with 1,000+ births shown | Dashed line = overall average",
    x = NULL,
    y = "NCC Admission Rate (%)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14)
  )
```

---

# Dataset Construction Methodology

::: {.callout-note collapse="true"}
## Data Sources (click to expand)

### Primary Data Sources

1. **MSDS (Maternity Services Dataset)** - NHS Digital national maternity data:
   - `MSD401BabyDemographics_1`: Birth details and baby demographics
   - `MSD301LabourDelivery_1`: Labour and delivery information
   - `MSD101PregnancyBooking_1`: Pregnancy booking and social factors
   - `MSD001MotherDemog_1`: Mother demographics
   - `MSD402NeonatalAdmission_1`: MSDS-reported neonatal admissions

2. **Critical Care (Pbr_CC_Monthly)** - Daily-level critical care records:
   - Filtered by `CC_Type = 'NCC'` for neonatal critical care
   - Contains care levels, length of stay, and clinical details
   - Used for Payment by Results (contractual requirement)

3. **APCS (Admitted Patient Care Spells)** - `APCS_Core_Daily`:
   - Provides NHS Numbers for linkage between MSDS and CC data
   - Essential linkage table
:::

::: {.callout-note collapse="true"}
## Data Linkage Strategy (click to expand)

1. Start with MSDS births (MSD401BabyDemographics_1) as base
2. Link MSDS tables via `Labour_Delivery_ID`, `UniqPregID`, `Person_ID_Mother`
3. Link to CC data via `NHS_Number` (pseudonymised) through APCS
4. Apply 90-day date proximity filter when linking births to CC admissions
5. Compare NCC admission status from both MSDS and CC sources

**Time Period**: Financial Year 2023/24 (April 1, 2023 - March 31, 2024)
:::

## Data Quality: Resolving Duplication

A critical data quality issue was identified and resolved during dataset construction.

```{r duplication_viz, echo=FALSE, fig.height=4}
#| label: fig-duplication
#| fig-cap: "MSDS tables contained significant duplication that required resolution"

duplication_data <- tibble(
  Table = c("Baby Demographics", "Labour/Delivery", "Pregnancy/Booking",
            "Neonatal Admissions", "Mother Demographics"),
  `Duplication Factor` = c(3.4, 3.6, 10.1, 2.1, 10)
)

ggplot(duplication_data, aes(x = reorder(Table, `Duplication Factor`), y = `Duplication Factor`)) +
  geom_col(fill = nhs_pink, width = 0.6) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "darkgreen", linewidth = 1) +
  geom_text(aes(label = paste0(round(`Duplication Factor`, 1), "x")),
            hjust = -0.2, size = 4, fontface = "bold") +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  labs(
    title = "Data Duplication in MSDS Tables",
    subtitle = "Green line = expected (1x, no duplication)",
    x = NULL,
    y = "Duplication Factor"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    panel.grid.major.y = element_blank()
  )
```

::: {.callout-important}
## Why This Matters
Without deduplication, the dataset would have contained ~1.8 million records instead of the correct ~540,000 births. This would have severely biased any analysis.
:::

::: {.callout-note collapse="true"}
## Technical Details: Deduplication Strategy (click to expand)

Investigation revealed that **91.6% of babies** had duplicate records, with some having up to 32 duplicates. However, **45 out of 50 fields were identical** across duplicates - only submission metadata differed.

**Conclusion**: Duplicates represent multiple submissions of identical data, not different clinical events.

**Solution applied**:
```sql
ROW_NUMBER() OVER (
  PARTITION BY [natural_key]
  ORDER BY UniqSubmissionID DESC  -- Most recent submission
) AS rn

-- Then filter: WHERE rn = 1
```
:::

## NCC Data Source Comparison

We compared NCC admission data from two sources to ensure data quality:

```{r source_comparison_viz, echo=FALSE, fig.height=4}
#| label: fig-source-comparison
#| fig-cap: "Critical Care data captures significantly more NCC admissions than MSDS"

ncc_breakdown <- data %>%
  mutate(
    NCC_Source = case_when(
      NCC_MSDS_Admitted == 1 & NCC_CC_Admitted == 1 ~ "Both sources",
      NCC_MSDS_Admitted == 1 & (is.na(NCC_CC_Admitted) | NCC_CC_Admitted == 0) ~ "MSDS only",
      (is.na(NCC_MSDS_Admitted) | NCC_MSDS_Admitted == 0) & NCC_CC_Admitted == 1 ~ "CC only",
      TRUE ~ "Not admitted"
    )
  ) %>%
  filter(NCC_Source != "Not admitted") %>%
  count(NCC_Source) %>%
  mutate(Percentage = n / sum(n) * 100)

ggplot(ncc_breakdown, aes(x = reorder(NCC_Source, n), y = n, fill = NCC_Source)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = paste0(format(n, big.mark = ","), "\n(", round(Percentage, 1), "%)")),
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  scale_fill_manual(values = c("Both sources" = nhs_green, "CC only" = nhs_blue, "MSDS only" = nhs_light_blue)) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.25))) +
  labs(
    title = "Where NCC Admissions Are Recorded",
    subtitle = "CC = Critical Care dataset | MSDS = Maternity Services Dataset",
    x = NULL,
    y = "Number of NCC Admissions"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 14),
    panel.grid.major.y = element_blank()
  )
```

::: {.callout-tip}
## Decision: Use Critical Care as Primary Source
Critical Care data captures **3.76x more** NCC admissions than MSDS (due to contractual Payment by Results reporting requirements). The combined flag `NCC_Admitted = 1` if baby appears in **either** source.
:::

---

# Descriptive Statistics

## Overall Dataset Summary

```{r overall_summary, echo=FALSE}
summary_stats <- tibble(
  Metric = c(
    "Total births in 2023/24",
    "NCC admissions (any source)",
    "NCC admission rate",
    "Births without NCC admission",
    "Number of variables in dataset"
  ),
  Value = c(
    format(nrow(data), big.mark = ","),
    format(sum(data$NCC_Admitted, na.rm = TRUE), big.mark = ","),
    paste0(round(100 * mean(data$NCC_Admitted, na.rm = TRUE), 2), "%"),
    format(sum(data$NCC_Admitted == 0, na.rm = TRUE), big.mark = ","),
    ncol(data)
  )
)

kable(summary_stats,
      col.names = c("Metric", "Value"),
      align = c("l", "r")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE)
```

## Baby Demographics

### Sex Distribution and NCC Rates

```{r sex_viz, echo=FALSE, fig.height=4}
#| label: fig-sex-ncc
#| fig-cap: "NCC admission rates by baby's sex"

sex_data <- data %>%
  mutate(Sex = case_when(
    Baby_Sex == "1" ~ "Male",
    Baby_Sex == "2" ~ "Female",
    Baby_Sex == "9" ~ "Indeterminate",
    TRUE ~ "Unknown"
  )) %>%
  group_by(Sex) %>%
  summarise(
    Total = n(),
    NCC_Admitted = sum(NCC_Admitted, na.rm = TRUE),
    Rate = 100 * NCC_Admitted / Total,
    .groups = "drop"
  )

ggplot(sex_data, aes(x = Sex, y = Rate, fill = Sex)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = paste0(round(Rate, 1), "%\n(n=", format(NCC_Admitted, big.mark = ","), ")")),
            vjust = -0.2, size = 3.5) +
  scale_fill_manual(values = c("Male" = nhs_blue, "Female" = nhs_pink,
                               "Indeterminate" = nhs_aqua, "Unknown" = "grey60")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  labs(
    title = "NCC Admission Rate by Sex",
    x = NULL,
    y = "NCC Admission Rate (%)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 14),
    panel.grid.major.x = element_blank()
  )
```

### Ethnicity Distribution

```{r ethnicity_table, echo=FALSE}
ethnicity_dist <- data %>%
  mutate(Ethnicity = decode_ethnicity(Ethnic_Category_Baby)) %>%
  group_by(Ethnicity) %>%
  summarise(
    Count = n(),
    NCC_Admitted = sum(NCC_Admitted, na.rm = TRUE),
    `NCC Rate (%)` = round(100 * NCC_Admitted / Count, 2),
    .groups = "drop"
  ) %>%
  arrange(desc(Count)) %>%
  head(12) %>%
  mutate(
    Count = format(Count, big.mark = ","),
    NCC_Admitted = format(NCC_Admitted, big.mark = ",")
  )

kable(ethnicity_dist,
      col.names = c("Ethnicity", "Births", "NCC Admissions", "NCC Rate (%)"),
      align = c("l", "r", "r", "r")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE)
```

## Clinical Characteristics

### Gestation Length

```{r gestation_viz, echo=FALSE, fig.height=4}
#| label: fig-gestation
#| fig-cap: "Distribution of gestation length at birth"

# Create gestation categories (using Gestation_Weeks calculated from days)
data_gest <- data %>%
  filter(!is.na(Gestation_Weeks)) %>%
  mutate(
    Gestation_Group = case_when(
      Gestation_Weeks < 28 ~ "Extremely preterm (<28 weeks)",
      Gestation_Weeks < 32 ~ "Very preterm (28-31 weeks)",
      Gestation_Weeks < 37 ~ "Moderate/Late preterm (32-36 weeks)",
      Gestation_Weeks <= 42 ~ "Term (37-42 weeks)",
      TRUE ~ "Post-term (>42 weeks)"
    ),
    Gestation_Group = factor(Gestation_Group, levels = c(
      "Extremely preterm (<28 weeks)", "Very preterm (28-31 weeks)",
      "Moderate/Late preterm (32-36 weeks)", "Term (37-42 weeks)", "Post-term (>42 weeks)"
    ))
  )

gest_summary <- data_gest %>%
  group_by(Gestation_Group) %>%
  summarise(
    Count = n(),
    NCC_Rate = 100 * mean(NCC_Admitted, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(gest_summary, aes(x = Gestation_Group, y = Count, fill = NCC_Rate)) +
  geom_col() +
  geom_text(aes(label = paste0(format(Count, big.mark = ","), "\n(", round(NCC_Rate, 0), "% NCC)")),
            vjust = -0.1, size = 3) +
  scale_fill_gradient(low = nhs_light_blue, high = nhs_pink, name = "NCC Rate (%)") +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Births by Gestation Length",
    subtitle = "Colour indicates NCC admission rate for each group",
    x = NULL,
    y = "Number of Births"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text.x = element_text(angle = 30, hjust = 1),
    panel.grid.major.x = element_blank()
  )
```

### Delivery Method

```{r delivery_table, echo=FALSE}
delivery_dist <- data %>%
  mutate(Method = decode_delivery(Delivery_Method_Code)) %>%
  group_by(Method) %>%
  summarise(
    Count = n(),
    NCC_Admitted = sum(NCC_Admitted, na.rm = TRUE),
    `NCC Rate (%)` = round(100 * NCC_Admitted / Count, 2),
    .groups = "drop"
  ) %>%
  arrange(desc(Count)) %>%
  mutate(
    Percentage = round(100 * as.numeric(gsub(",", "", Count)) / nrow(data), 1),
    Count = format(Count, big.mark = ","),
    NCC_Admitted = format(NCC_Admitted, big.mark = ",")
  )

kable(delivery_dist %>% select(Method, Count, Percentage, NCC_Admitted, `NCC Rate (%)`),
      col.names = c("Delivery Method", "Births", "% of Total", "NCC Admissions", "NCC Rate (%)"),
      align = c("l", "r", "r", "r", "r")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE)
```

## NCC Admission Characteristics

### Time to NCC Admission

```{r time_to_ncc_viz, echo=FALSE, fig.height=4}
#| label: fig-time-to-ncc
#| fig-cap: "Most babies are admitted to NCC within hours of birth"

time_data <- data %>%
  filter(NCC_CC_Admitted == 1, !is.na(Hours_Birth_To_NCC_CC)) %>%
  mutate(
    Time_Group = case_when(
      Hours_Birth_To_NCC_CC <= 1 ~ "Within 1 hour",
      Hours_Birth_To_NCC_CC <= 6 ~ "1-6 hours",
      Hours_Birth_To_NCC_CC <= 24 ~ "6-24 hours",
      Hours_Birth_To_NCC_CC <= 72 ~ "1-3 days",
      TRUE ~ "More than 3 days"
    ),
    Time_Group = factor(Time_Group, levels = c(
      "Within 1 hour", "1-6 hours", "6-24 hours", "1-3 days", "More than 3 days"
    ))
  ) %>%
  count(Time_Group) %>%
  mutate(Percentage = 100 * n / sum(n))

ggplot(time_data, aes(x = Time_Group, y = n, fill = Time_Group)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = paste0(format(n, big.mark = ","), "\n(", round(Percentage, 1), "%)")),
            vjust = -0.1, size = 3.5) +
  scale_fill_manual(values = c(nhs_dark_blue, nhs_blue, nhs_bright_blue, nhs_light_blue, nhs_aqua)) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Time from Birth to NCC Admission",
    x = NULL,
    y = "Number of Babies"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 14),
    panel.grid.major.x = element_blank()
  )
```

### NCC Length of Stay

```{r ncc_los_viz, echo=FALSE, fig.height=4}
#| label: fig-los
#| fig-cap: "Distribution of NCC length of stay"

los_data <- data %>%
  filter(NCC_CC_Admitted == 1, !is.na(NCC_CC_Total_Days)) %>%
  mutate(
    LOS_Group = case_when(
      NCC_CC_Total_Days <= 1 ~ "1 day",
      NCC_CC_Total_Days <= 3 ~ "2-3 days",
      NCC_CC_Total_Days <= 7 ~ "4-7 days",
      NCC_CC_Total_Days <= 14 ~ "1-2 weeks",
      NCC_CC_Total_Days <= 28 ~ "2-4 weeks",
      TRUE ~ "More than 4 weeks"
    ),
    LOS_Group = factor(LOS_Group, levels = c(
      "1 day", "2-3 days", "4-7 days", "1-2 weeks", "2-4 weeks", "More than 4 weeks"
    ))
  ) %>%
  count(LOS_Group) %>%
  mutate(Percentage = 100 * n / sum(n))

ggplot(los_data, aes(x = LOS_Group, y = n, fill = LOS_Group)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.3, size = 3.5) +
  scale_fill_manual(values = c(nhs_green, nhs_aqua, nhs_light_blue, nhs_blue, nhs_bright_blue, nhs_dark_blue)) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "NCC Length of Stay",
    x = NULL,
    y = "Number of Babies"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 14),
    panel.grid.major.x = element_blank()
  )
```

## Maternal Demographics

### Mother's Ethnicity and NCC Rates

```{r mother_ethnicity_viz, echo=FALSE, fig.height=5}
#| label: fig-mother-ethnicity
#| fig-cap: "NCC admission rates by mother's ethnicity"

mother_eth_rates <- data %>%
  mutate(Ethnicity = decode_ethnicity(Ethnic_Category_Mother)) %>%
  group_by(Ethnicity) %>%
  summarise(
    Total = n(),
    NCC_Admitted = sum(NCC_Admitted, na.rm = TRUE),
    Rate = 100 * NCC_Admitted / Total,
    .groups = "drop"
  ) %>%
  filter(Total >= 1000) %>%
  arrange(desc(Rate))

ggplot(mother_eth_rates, aes(x = reorder(Ethnicity, Rate), y = Rate, fill = Rate)) +
  geom_col() +
  geom_hline(yintercept = mean(data$NCC_Admitted, na.rm = TRUE) * 100,
             linetype = "dashed", color = "red", linewidth = 0.8) +
  coord_flip() +
  scale_fill_gradient(low = nhs_light_blue, high = nhs_dark_blue, guide = "none") +
  labs(
    title = "NCC Admission Rate by Mother's Ethnicity",
    subtitle = "Groups with 1,000+ births shown | Dashed line = overall average",
    x = NULL,
    y = "NCC Admission Rate (%)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14)
  )
```

## Social Factors (Inequality Measures)

```{r social_factors_viz, echo=FALSE, fig.height=4}
#| label: fig-social-factors
#| fig-cap: "NCC rates are higher for mothers with complex social factors"

social_data <- data %>%
  mutate(
    Social_Factors = case_when(
      Complex_Social_Factors_Indicator_At_Antenatal_Booking == "Y" ~ "Yes - Complex Factors",
      Complex_Social_Factors_Indicator_At_Antenatal_Booking == "N" ~ "No Complex Factors",
      TRUE ~ "Not Recorded"
    )
  ) %>%
  group_by(Social_Factors) %>%
  summarise(
    Total = n(),
    NCC_Admitted = sum(NCC_Admitted, na.rm = TRUE),
    Rate = 100 * NCC_Admitted / Total,
    .groups = "drop"
  )

ggplot(social_data, aes(x = Social_Factors, y = Rate, fill = Social_Factors)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = paste0(round(Rate, 1), "%\n(n=", format(Total, big.mark = ","), ")")),
            vjust = -0.2, size = 3.5) +
  scale_fill_manual(values = c("Yes - Complex Factors" = nhs_pink,
                               "No Complex Factors" = nhs_blue,
                               "Not Recorded" = "grey60")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  labs(
    title = "NCC Admission Rate by Complex Social Factors at Booking",
    x = NULL,
    y = "NCC Admission Rate (%)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 14),
    panel.grid.major.x = element_blank()
  )
```

---

# Data Quality Assessment

## Completeness by Key Variable

```{r completeness, echo=FALSE}
key_vars <- c(
  "NHS_Number_Baby",
  "Baby_Birth_Date",
  "Baby_Sex",
  "Ethnic_Category_Baby",
  "Gestation_Length_At_Birth",
  "Delivery_Method_Code",
  "Ethnic_Category_Mother",
  "NCC_Admitted",
  "NCC_Hospital_Provider_Code",
  "Mother_CCG_Residence"
)

completeness <- tibble(
  Variable = key_vars,
  `Complete Records` = sapply(key_vars, function(v) {
    format(sum(!is.na(data[[v]])), big.mark = ",")
  }),
  `Missing Records` = sapply(key_vars, function(v) {
    format(sum(is.na(data[[v]])), big.mark = ",")
  }),
  `% Complete` = sapply(key_vars, function(v) {
    round(100 * sum(!is.na(data[[v]])) / nrow(data), 2)
  })
)

kable(completeness,
      align = c("l", "r", "r", "r")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>%
  row_spec(which(completeness$`% Complete` < 90),
           background = "#fff3cd")
```

## Known Data Limitations

::: {.callout-warning}
## Data Gaps to Address

1. **Birth weight and Apgar scores**: Not available in main table; requires additional linkage
2. **Mother's age**: Date of birth not available; cannot calculate maternal age
3. **Deprivation (IMD)**: Requires LSOA-to-IMD linkage
4. **NCC source discrepancies**: Only 17.4% overlap between data sources
:::

---

# Technical Specifications

::: {.callout-note collapse="true"}
## Database Connection Details (click to expand)

- **Platform**: NHS UDAL (Unified Data Access Layer) on Azure Synapse Analytics
- **Authentication**: Azure Active Directory Interactive
- **Access**: Requires UDAL data access permissions
:::

::: {.callout-note collapse="true"}
## SQL Query Structure (click to expand)

The final query consists of several CTEs (Common Table Expressions):

1. `ncc_from_cc`: Aggregates daily CC records to baby-level
2. `apcs_link`: Provides NHS numbers for linkage
3. `ncc_cc_with_nhs`: Links CC data to NHS numbers
4. `msds_babies_raw` + `msds_babies`: Deduplicates baby demographics
5. `msds_labour_raw` + `msds_labour`: Deduplicates labour/delivery records
6. `msds_mothers_raw` + `msds_mothers`: Deduplicates mother demographics
7. `msds_pregnancy_raw` + `msds_pregnancy`: Deduplicates pregnancy/booking records
8. `msds_neonatal_adm_raw` + `msds_neonatal_adm`: Deduplicates neonatal admissions
9. `base_dataset`: Joins all deduplicated tables together
:::

::: {.callout-note collapse="true"}
## Output Specification (click to expand)

- **Format**: RDS (R Data Serialization)
- **Filename**: `data/ncc_base_dataset.rds`
- **Records**: `r format(nrow(data), big.mark = ",")`
- **Fields**: `r ncol(data)`
- **Granularity**: One record per baby born in hospital in 2023/24
:::

---

# Next Steps

## For Hierarchical Modelling

The dataset is now ready for hierarchical (mixed-effects) modelling to examine:

1. **Fixed effects** (patient characteristics):
   - Baby: Sex, ethnicity, gestation, birth order
   - Mother: Ethnicity, social factors, employment, disability
   - Delivery: Method, location

2. **Random effects** (hospital/provider variation):
   - `NCC_Hospital_Provider_Code`: Where NCC care was provided
   - `Delivery_Site_Code`: Where baby was born

3. **Outcome variables**:
   - Binary: `NCC_Admitted` (1/0)
   - Time-to-event: `Hours_Birth_To_NCC_CC` (for survival/frailty models)

---

# Conclusions

1. **Successful dataset construction**: Created a clean, deduplicated birth-level dataset with `r format(nrow(data), big.mark = ",")` records for FY 2023/24

2. **Critical deduplication**: Identified and resolved 2-10x duplication in MSDS tables

3. **Data source selection**: Critical Care data provides more comprehensive NCC admission capture (11.6% vs 3.1%)

4. **Ready for analysis**: Dataset has appropriate granularity and key variables for inequality analysis

5. **Known limitations**: Some clinical variables (birth weight, Apgar, IMD) require additional linkage

---

# Appendix: Variable List

::: {.callout-note collapse="true"}
## Complete Variable List (click to expand)

```{r variable_list, echo=FALSE}
var_list <- tibble(
  Variable = names(data),
  Type = sapply(data, class),
  `Non-Missing` = format(sapply(data, function(x) sum(!is.na(x))), big.mark = ","),
  `% Complete` = round(sapply(data, function(x) 100 * sum(!is.na(x)) / length(x)), 1)
)

kable(var_list,
      align = c("l", "l", "r", "r")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE,
                font_size = 11) %>%
  scroll_box(height = "400px")
```
:::

---

**Report generated**: `r Sys.time()`

**R version**: `r R.version.string`

**Dataset file**: `data/ncc_base_dataset.rds`
